# Code coverage with the “ignorant” jacoco


## Description

Jacoco code coverage tool (combined with Jenkins and SonarQube) is absolutely the tool any production project has to include in its CI/CD pipelines.

It combines/merges the result of many code quality tools under a good structured Web UI. 

It also allow further customisation through UI based configuration or project management (maven plugin) configuration.

Through thresholds configuration the project CI/CD pipeline could pass only if the code meat a required quality. 

## Receipt 

<span style='color:magenta'>__Exclude code from jacoco coverage for__
- methods (constructors) of POJO (Java beans) generated by lombok
- methods (i.e. toString) generated by IntelliJ Idea

## Context 

The project is based on java an maven.

Some time ago I started a small but important simplification in a project codebase.

One of the improvements was about the migration of dummy POJOs (Java beans) generated by  the IntelliJ Idea to the ones generated by lombok.

The code coverage of the project was above the 75% threshold. 

## Target 

<span style='color:magenta'>__Code simplification with lombok__
1. less (both production and test) code
1. more maintainable code (because of 1.) 
1. keep or improve the code coverage but with not a single additional line of unit tests. 


## How to do it

1. Configure lombok in maven pom.xml

    ```xml
   
   <!-- in dependencies -->
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <version>1.18.10</version>
      <scope>provided</scope>
    </dependency>    
   
    <!-- in build/plugins --> 
    <plugin>
     <groupId>org.apache.maven.plugins</groupId>
     <artifactId>maven-compiler-plugin</artifactId>
     <version>3.8.1</version>
     <configuration>
       <annotationProcessorPaths>
         <path>
           <groupId>org.projectlombok</groupId>
           <artifactId>lombok</artifactId>
           <version>1.18.10</version>
         </path>
       </annotationProcessorPaths>
       <source>1.8</source>
       <target>1.8</target>
     </configuration>
    </plugin>
    ```
    
    Notes:
    
    > I highly recommend the maven compiler configuration of annotationProcessorPaths (some CI/CD tools go crazy without it) 

1. Migrate the POJO (java beans) to lombok based ones

    ```java
    import lombok.AccessLevel;
    import lombok.AllArgsConstructor;
    import lombok.EqualsAndHashCode;
    import lombok.EqualsAndHashCode.Include;
    import lombok.Getter;
    import lombok.ToString;
    
    @ToString
    @EqualsAndHashCode(onlyExplicitlyIncluded = true, doNotUseGetters = true)
    @Getter
    @AllArgsConstructor(access = AccessLevel.PRIVATE)
    public class Notification {
    
    @Include
    private final NotificationID id;
   
    // ....
    }
    ```

1. Fix the code quality failure raised by the significant drop of code coverage percentage under 75%.

    1. <span style='color:red'>Jacoco complained about the uncovered code in lombok based java sources. 
    
        How to fix: 
        
        - create (if not already existed) the file `lombok.config` in the project root.
    
        - add the following content:
        
        ```text
        lombok.addLombokGeneratedAnnotation = true
        ```
       
       Note: 
       
       > This settings requires jacoco maven plugin later than 0.8.0.

    1. <span style='color:red'>Jacoco also complained that some IntelliJ Idea generated toString methods was not covered by tests (note: no lombok for these classes).
    
        Because this is also a generated method it would be fine to configure SonarQube to ignore the methods generated by IntelliJ Idea.  
        This feature requires jacoco maven plugin greater than 0.8.2.
        
        How to do it:
        
        - <span style='color:blue'>Option 1</span> is to manually annotate the toString overridden method with `@lombok.Generated`

        - <span style='color:blue'>Option 2</span> is to configure the IntelliJ Idea to automatically add this annotation to the generated toString
        
            How to do this:

            - open the java file in editor
            - hit CTRL-N to open the live generated template list popup 
            - choose toString
            
              ![choose toString](./images/sonarqube/generated/generated_1.png)
            - hit Settings button
            
              ![hit settings](./images/sonarqube/generated/generated_2.png)
            - select the Templates tab
            - selects the StringJoiner (JDK 1.8) or whatever template you want to customize with the additional annotation 
            - hit copy button
            - Name the new template `StringJoiner (JDK 1.8) - lombok.generated` 
            - Add @lombok.Generated as first line in the template. See image no 1 below.
            
              ![hit settings](./images/sonarqube/generated/generated_3.png)

From now on, whenever, in a (maven/lombok/java) project, someone wants jacoco to ignore the toString generated code just 

- hit Ctrl-N and then 
- choose the `StringJoiner (JDK 1.8) - lombok.generated`. 
as can be seen in the following images.

![call the new template](./images/sonarqube/generated/generated_4.png)

![select StringJoiner (JDK 1.8) - lombok.generated](./images/sonarqube/generated/generated_5.png)

![the generated code](./images/sonarqube/generated/generated_6.png)


## Take away

In this short recipe we found out:

- most importantly 
    - what need to be done to configure jacoco to ignore the lombok java classes
    - how to configure IntelliJ Idea to assist jacoco in ignoring the IDE generated toString
- but also how to configure lombok in a maven project.

## Notes 

> There are lots of contradictory opinions about the lombok generated code (mainly because the lombok is not only a plain Annotation Processing Tool - but also a tool which uses the internal java compiler API - javac). 
>
>This could be a good topic for another discussion. In my personal opinion using lombok for regular POJOs (Java beans) does not hurt at all (or has the smallest negative impact). 
>But, on the contrary, it makes the code more readable and maintainable.

## References

- [More about sonarqube](https://docs.sonarqube.org/latest/architecture/architecture-integration/)
- [How to setup a threshold to fail the build because of the not met code quality](https://www.eclemma.org/jacoco/trunk/doc/check-mojo.html#haltOnFailure) 
- [How to merge jacoco reports for both IT and UT](https://www.eclemma.org/jacoco/trunk/doc/merge-mojo.html)
- [How to configure jacoco with maven](https://www.petrikainulainen.net/programming/maven/creating-code-coverage-reports-for-unit-and-integration-tests-with-the-jacoco-maven-plugin/)
